<html>
	<head> 
        <title>PeerStreamIt</title>
        <meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width" name="viewport">
        <meta content="PeerStreamIt." name="description">

        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link rel="shortcut icon" href="favicon.ico">

        <link href="//kendo.cdn.telerik.com/2016.1.112/styles/kendo.common.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="http://kendo.cdn.telerik.com/2016.1.112/styles/kendo.black.min.css" />
        <link rel="stylesheet" href="/css/style.css">
        <link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
  		<script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.6/angular.js"></script>
        <script src="//kendo.cdn.telerik.com/2016.1.112/js/kendo.ui.core.min.js"></script>
    </head>
    <body>
        <div id="root"><div><header>
                <h1 class="logo"><a href="">peer<span>stream</span>it</a></h1>&nbsp;
            </header>

            <section id="image-container">
                <div id="image-wrap">
                            <video controls width="100%" height="100%" ></video>
                </div>
            </section>

            <footer>
                <span style="display: inline-block; width: 100%; text-align: center; color: white;" >Copyright © 2016 · Real Time Productions, LLC. All Rights Reserved</span>
            </footer></div></div>
            <div style="display:none" >
            	<div id="pwPrompt" >
            		<input type="password" id="txtPw" class="k-textbox" placeholder="Enter password..." />
            		<input type="submit" id="submitPw" />
            	</div>
            </div>
<script>

var promptWin = null;

$(document).ready(function() {
	promptWin = $("#pwPrompt").kendoWindow({actions: {}, modal: true, resizable: false, title: 'Content is password protected', width: 300, height: 60 }).data('kendoWindow');

	$("#submitPw").click(function() {

		doSend("PSIAUTH:" + $("#txtPw").val());

		promptWin.close();
        return false;
				});
});



function Logger() {
  
}

Logger.prototype.log = function(msg) {
  console.log(msg);
};

function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

var video;
var sourceBuffer;
var mediaSource;
var output;
var websocket;
var textID;

var queue = [];
var ready = true;

function sourceOpen() {

	sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42c01f, mp4a.40.2"');//'video/webm; codecs="vorbis,vp8"');
    
	sourceBuffer.addEventListener('updateend', function() {
		
	  if ( queue.length && queue.length > 0) {

		if(video.error != null) {

			console.log(video.error);
			ready = false;
		}
		else {

		    sourceBuffer.appendBuffer(queue.shift());
		    ready = false;
		}
			
		  
	    
	  } else {

		  ready = true;
			
	  }
	}, false);

	var videoCurrentTime = 0;
	
	video.addEventListener("timeupdate", function(event){
		
      videoCurrentTime = this.currentTime;
      
    });
    
	var lastSeekId = 0;
	
	video.addEventListener('seeking', function(e) { 

		lastSeekId++;
		
		(function(si) { setTimeout(function() {

			if(lastSeekId > 0 && si == lastSeekId) {

				lastSeekId = 0;
				websocket.send("PSISEEK:" + video.currentTime);
			}
			
		}, 2000) })(lastSeekId);
		
	});
}

			var logger = new Logger();

            var wsUri = getRootUri() + "/sockets";
 
            function getRootUri() {
                return "wss://peersockets-myappsplatform.rhcloud.com:8443";
            }

            var dataStart = null;
            var needed = 10;
            
            function init() {

				
            	//output = document.getElementById("output");
            	
            	var FILE = 'test.webm';
            	var NUM_CHUNKS = 5;
                video = document.querySelector('video');

            	window.MediaSource = window.MediaSource || window.WebKitMediaSource;
            	if (!!!window.MediaSource) {
            	  window.location = 'http://caniuse.com/#feat=mediasource';
            	}

            	mediaSource = new MediaSource();

            	mediaSource.addEventListener('sourceopen', sourceOpen);
            	//document.querySelector('[data-num-chunks]').textContent = NUM_CHUNKS;

				video.src = window.URL.createObjectURL(mediaSource);
            	
               // textID = document.getElementById("textID");

                websocket = new WebSocket(wsUri);


                websocket.onopen = function(evt) {
                    onOpen(evt)
                };
                websocket.onmessage = function(evt) {

					if(evt.data.size) {
						
						var arrayBuffer;
						var fileReader = new FileReader();
						fileReader.onload = function() {
						    arrayBuffer = this.result;

							if(ready == true) {

								if ( queue.length && queue.length > 0) {
									queue.push(arrayBuffer);
								    sourceBuffer.appendBuffer(queue.shift());
								    ready = false;
								    
								}
								else {
						    		sourceBuffer.appendBuffer(arrayBuffer);
									ready = false;
								}
							}else {

								queue.push(arrayBuffer);

						    }

						    if (dataStart == null) {
						    	//$("#stream-status").text("Buffering");

						    	dataStart = new Date();
					            //video.play(); // Start playing after 1st chunk is appended.
					          }
						    
						};
						
						fileReader.readAsArrayBuffer(evt.data);

					}
					else if(evt.data && evt.data.indexOf) {

					if(evt.data.indexOf('PSICHALLENGE') == 0 || evt.data.indexOf('PSIAUTHREJECTED') == 0) {

						promptWin.center();
						promptWin.open();

					}
					else if(evt.data.indexOf('TC:') == 0) {

							var retrieved = evt.data.split(':')[1];
							
							//$("#stream-buff").text(retrieved + "s");
							
							var now = new Date();

							var dif = now.getTime() - dataStart.getTime();

							var elapsed = dif / 1000;

							//$("#stream-elap").text(elapsed + "s");
							//$("#stream-vd").text(video.duration + "s");
							//$("#stream-pd").text((video.duration - parseInt(retrieved)) * (parseInt(retrieved) / elapsed) + "s");
							
							if(video.duration <= (video.duration - parseInt(retrieved)) * (parseInt(retrieved) / elapsed) ) {
								//$("#stream-status").text("Playing");
								video.play();

								setInterval(function() {

									websocket.send("PSITIME:" + video.currentTime);

									 }, 3000);
							}
						}
						
                    	onMessage(evt)
					}
                };
                websocket.onerror = function(evt) {
                    onError(evt)
                };
            }
 
            function send_message() {
                //doSend(textID.value);
            }
 
            function onOpen(evt) {
                writeToScreen("Connected to Endpoint!");
 				doSend('PSICLIKEY:' + getParameterByName('psi'));
 				//$("#stream-status").text("Starting stream");
            }
 
            function onMessage(evt) {
                writeToScreen("Message Received: " + evt.data);
            }
 
            function onError(evt) {
                writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
            }
 
            function doSend(message) {
                writeToScreen("Message Sent: " + message);
                websocket.send(message);
            }
 
            function writeToScreen(message) {

            }
 
            window.addEventListener("load", init, false);
 
        </script>
</body></html>